<!DOCTYPE HTML>
<html><head> 
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>Scaling - Bitronics Web Server</title> 
	<link rel="stylesheet" type="text/css" href="site.css">
	<link rel="icon" href="favicon.ico">
	
	<style type="text/css"> 
	
@font-face {
	font-family: "D7CMBI";
	src: url("./DSEG7ClassicMiniBoldItalic.woff2") format('woff2');
	/* licensed https://github.com/keshikan/DSEG/blob/master/DSEG-LICENSE.txt */
  }
.seven-seg {
	font-family: 'D7CMBI', 'Courier New Bold', Courier, monospace;
	letter-spacing: 2px;
	background-color:black; 
	color:red;
	padding-top: 2px;
	padding-bottom: 2px;
	/* font-size: 12px; */
}
.point-input{
	text-align: right;
}

input[type="file"] {
	display: none;
}
.custom-file-upload {
	border: 1px solid #ccc;
	display: inline-block;
	padding: 3px 7px;
	cursor: pointer;
	font-size: 13px;
	background: #dddddd;
	border-top: 1px solid #333333;
	border-right: 1px solid #333333;
	border-bottom: 1px solid #333333;
	border-left: 1px solid #333333;
}
	
	.color-p1 {
		background-color:lightgray
	}
	.color-p2 {
		background-color:lightsteelblue;
	}
	.color-w1 {
		background-color: #fff;
	}
 
.fixed_header {
  height:  220px;
  overflow-y: scroll;
  overflow-x: hidden;
}

.fixed_header th {
  position: -webkit-sticky;
  position: sticky;
  top: 0;
}

.fixed_header tfoot td {
	text-align: center;
	font-size: 90%;
	font-style:oblique;
	color: gray;
}

.fixed_header td input, .fixed_header td select{
	width: 115px !important;
}

.fixed_header th, .fixed_header td {
  width: 126px !important;
  padding: 3px;
  /* text-align: left; */
}

/* .fixed_header {
  border: 1px solid #ccc;
  border-collapse: collapse;
} */

	</style>


	<script src="jquery.min.js"></script>    
	<script src="request.js"></script>
	<script src="content.js"></script>
	<script src="scaling.js"></script>
	<script src="tv4.min.js"></script>
	
	
	

	
</head>
<body>
<div id="Content"></div>

<div class="pagebox" id="page">
<noscript><a class="noscript">This page requires Javascript.</a></noscript>

<div id="trail"><a href="settings.html">Settings</a> / Scaling</div>
<div id="message"></div>

<h2>Scalings</h2>

<div class="fixed_header">
<table id="scaling_tbl" cellspacing="0">
	<thead>
		<tr>
			<th class="label2 color-w1"></th>
			<th class="label2 color-p1" COLSPAN=2 style="text-align: center">Point 1</th>
			<th class="label2 color-p2" COLSPAN=2 style="text-align: center">Point 2</th>
			<th class="label2 color-w1"></th>
		</tr>
		<tr>
			<th class="label2 color-w1">Name</th>
			<th class="label2 color-p1 fh-row2" style="text-align: center">Polled</th>
			<th class="label2 color-p1 fh-row2" style="text-align: center">Displayed</th>
			<th class="label2 color-p2 fh-row2" style="text-align: center">Polled</th>
			<th class="label2 color-p2 fh-row2" style="text-align: center">Displayed</th>
			<th><button onclick="addFieldScaling();">Add Scaling</button></th>
		</tr>
	</thead>
	<tbody id="tablebodyScalings"></tbody>
	<tfoot>
		<tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
		<tr>
			<td>enter a name</td>
			<td colspan=2>enter a polled value and its display format</td>
			<td colspan=2>enter a second pair of values</td>
			<td></td>
		</tr>
	</tfoot>
</table>
</div>

<br/><br/>

<h2>Measurements</h2>

<div class="fixed_header">
<table id="measurement_tbl" cellspacing="0">
	<thead>
		<tr>
			<th class="label2 color-w1">Name</th>
			<th class="label2 color-w1">Scaling</th>
			<th class="label2 color-w1">Phase</th>
			<th class="label2 color-w1">Modifier</th>
			<th class="label2 color-w1">Rows</th>
			<th class="label2 color-w1"><button onclick="addFieldMeasurement();">Add Measurement</button></th>
		</tr>
	</thead>
	<tbody id="tablebodyMeasurements"></tbody>
	<tfoot>
		<tr><td></td><td></td><td></td><td></td><td></td></tr>
		<tr>
			<td>enter a name</td>
			<td>select scaling method</td>
			<td COLSPAN=2>select optional LEDs to illuminate</td>
			<td>select row span</td>
		</tr>
	</tfoot>

</table>
</div>

<p style=" width:100%; text-align: left; margin-bottom: 0px; display:inline-block;">
	<button style="margin-right: 10%;" onclick="saveFile();">Save to File</button>
	<label for="jsonFile" class="custom-file-upload">Open from File</label>
	<input id="jsonFile" type="file" />
</p>

<p style="margin-top: 0px;" >
<div id="upbox" class="ubox">
	<button onclick="serialize();">Apply</button>
	<a id="msg" class="msg"></a>
</div>
</p>

<form action="http:restore.cgi" method="POST" name="dflts" id="dflts" onsubmit="return get_resp()">
<input type="hidden" name="dflt" id="dflt" value="scaling"/>
<input type="submit" name="restore" value="Restore Defaults" />
</form>
</div>
<div class="pagebox"><div id="footer"></div></div>
	<script>
//<!--

//Load scaling from a Json file
document.getElementById('jsonFile').addEventListener('change', onChange);


function onChange(event) {
	
		 var ext = this.value.match(/\.([^\.]+)$/)[1];
		 if(ext == 'json'){
		 	var reader = new FileReader();
			reader.readAsText(event.target.files[0]);
			reader.onload = onReaderLoad;
		 }else{
		 	alert('Only Json files are allowed');
		 	this.value = '';
		 }        
	}

function onReaderLoad(event){
		
		//async json schema fetch
		fetch('FlexScale.schema.json')
		.then(function(resp){
			return resp.json();
		})
		.then(function(data){
			
			jsonSchema = {};
			jsonSchema = data;
			
			//getting json from file, parsing and validating it
			try {
				validate(JSON.parse(event.target.result), jsonSchema);
				parse_vars(firmware_json_from(event.target.result));
			} catch (error) {
				error += "\nFix file and re-open."
				alert(error);
				console.log(error);
			}
			//Unload file input
			document.getElementById('jsonFile').value = "";
			
		})
	}


	//Save scalings to a Json file
function saveFile() {
	
	
		//async json schema fetch
		fetch('FlexScale.schema.json')
		.then(function(resp){
			return resp.json();
		})
		.then(function(data){
			
			jsonSchema = {};
			jsonSchema = data;
			
			obj = specialFormat();
			try {
				var valid = validate(obj, jsonSchema);
				firmware_json_from(JSON.stringify(obj)); // for decimal pt validation
				var payload = JSON.stringify(obj, null, ' ');
			} catch (error) {
				error += "\nFix and re-save."
				alert(error);
				console.log(error);
				valid = false;
			}

			if(valid == true){ // file is valid
					payload = payload.replace(/\[\n\s+\"/g, '["');
					payload = payload.replace(/\"\,\n\s+\"/g, '", "');
					payload = payload.replace(/\"\n\s+/g, '"');
					payload = payload.replace(/\,\n\s\s\s\s\"/g, ', "');
					payload = payload.replace(/\[\n\s+/g, '[');
					payload = payload.replace(/\[\[/g, '[\n   \[');
					download(payload, 'scalings.json','application/json');
			}
		})
}



function specialFormat(){
	
		var obj = {};

	// Build a list of each scaling row in the table
	var scaling_tbl = id('scaling_tbl');
	var scaling_lst = scaling_tbl.querySelectorAll("[flexscaling]");

	// keep the scaling data in an object and then jsonify it.
	
	var scalings = {};
	for (var scr of scaling_lst) {
		scalings[scr.flexscaling.nm] = [];
		scalings[scr.flexscaling.nm].push([parseInt(scr.flexscaling.x1), scr.flexscaling.y1]);
		scalings[scr.flexscaling.nm].push([parseInt(scr.flexscaling.x2), scr.flexscaling.y2]);
	}
	obj.scalings = scalings;
	
	
	
	// Build a list of each measurement row in the table
	var measurement_tbl = id('measurement_tbl');
	var measurement_lst = measurement_tbl.querySelectorAll("[measurement]");

	// Convert the format of each measurement and serialize the list of scalings
	msrmnt = {};
	for (var scr of measurement_lst) {
		//console.log(slpoff_from_points(scr.flexscaling));
		//msrmnt.push(scr.measurement);
		msrmnt[scr.measurement.nm] = [];
		msrmnt[scr.measurement.nm].push(scr.measurement.scl, scr.measurement.phs, scr.measurement.nxa, scr.measurement.row);
	}
	
	obj.measurements = msrmnt;
	
	return obj;
	
}




function download(text, name, type)
	{
		var file = new Blob([text], {type: type});
		var isIE = /*@cc_on!@*/false || !!document.documentMode;
		if (isIE)
		{
			window.navigator.msSaveOrOpenBlob(file, name);
		}
		else
		{
			var a = document.createElement('a');
			a.href = URL.createObjectURL(file);
			a.download = name;
			a.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
		}
	 }




window.SomeDeleteRowFunction = function SomeDeleteRowFunction(o) {
	 var p=o.parentNode.parentNode;
	 p.parentNode.removeChild(p);
}


 function addFieldScaling(argument) {
			var myTable = document.getElementById("tablebodyScalings");
			var currentIndex = myTable.rows.length;
			var currentRow = myTable.insertRow(-1);

			var name = document.createElement("input");
			name.setAttribute("name", "nm");
			name.setAttribute('maxlength', 31);
			name.setAttribute('placeholder', 'example');
			
			var p1poll = document.createElement("input");
			p1poll.setAttribute("name", "x1");
			p1poll.setAttribute('maxlength', 12);
			p1poll.setAttribute('class', 'point-input');
			p1poll.setAttribute('placeholder', '-1000');
			
			var p1show = document.createElement("input");
			p1show.setAttribute("name", "y1");
			p1show.setAttribute('maxlength', 12);
			p1show.setAttribute('class', 'point-input seven-seg');
			p1show.setAttribute('placeholder','-1.000');
			
			var p2poll = document.createElement("input");
			p2poll.setAttribute("name", "x2");
			p2poll.setAttribute('maxlength', 12);
			p2poll.setAttribute('class', 'point-input');
			p2poll.setAttribute('placeholder', '1000');
			
			var p2show = document.createElement("input");
			p2show.setAttribute("name", "y2");
			p2show.setAttribute('maxlength', 12);
			p2show.setAttribute('class', 'point-input seven-seg');
			p2show.setAttribute('placeholder','1.000');
	  
			/*var keywordsBox = document.createElement("input");
			keywordsBox.setAttribute("name", "keywords" + currentIndex);*/

			var deleteRowBox = document.createElement("input");
			deleteRowBox.setAttribute("type", "button");
			deleteRowBox.setAttribute("value", "Delete");
			deleteRowBox.setAttribute("onclick", "SomeDeleteRowFunction(this);");
			deleteRowBox.setAttribute("class", "button");
			deleteRowBox.setAttribute("style", "width: 85px !important;");
			

			currentRow.setAttribute("flexscaling", true);
			currentRow.flexscaling = new Scaling('', [[0, 0], [0, 0]]);
			
			var currentCell = currentRow.insertCell(-1);
			name.onblur = update_scaling_onblur(currentRow);
			currentCell.appendChild(name);

			currentCell = currentRow.insertCell(-1);
			p1poll.onblur = update_scaling_onblur(currentRow);
			currentCell.setAttribute('class', "color-p1");
			currentCell.appendChild(p1poll);

			currentCell = currentRow.insertCell(-1);
			p1show.onblur = update_scaling_onblur(currentRow);
			currentCell.setAttribute('class', "color-p1");
			currentCell.appendChild(p1show);
			
			currentCell = currentRow.insertCell(-1);
			p2poll.onblur = update_scaling_onblur(currentRow);
			currentCell.setAttribute('class', "color-p2");
			currentCell.appendChild(p2poll);

			currentCell = currentRow.insertCell(-1);
			p2show.onblur = update_scaling_onblur(currentRow);
			currentCell.setAttribute('class', "color-p2");
			currentCell.appendChild(p2show);

			currentCell = currentRow.insertCell(-1);
			currentCell.appendChild(deleteRowBox);

			name.focus();
		}



 function addFieldMeasurement(argument) {
 	
 	function fillSelect(selectName, options){
 		
 		for (var each of options) {
			  var option = document.createElement("option");
			  option.setAttribute("value", each);
			  option.text = each;
			  selectName.appendChild(option);
			}
 		
 	}
 	
 	
			var myTable = document.getElementById("tablebodyMeasurements");
			var currentIndex = myTable.rows.length;
			var currentRow = myTable.insertRow(-1);

			var name = document.createElement("input");
			name.setAttribute("name", "nm");
			name.setAttribute('maxlength', 31);
			
			var scalingSelect = document.createElement("select");
			scalingSelect.setAttribute("name", "scl");
			scalingSelect.setAttribute('class', "scl");
			scalingSelect.setAttribute('style', 'width: 100%');  
			fillSelect(scalingSelect, getNamesFromScaling());  

			var phase = document.createElement("select");
			phase.setAttribute("name", "phs");
			phase.setAttribute('class', "phs");
			phase.setAttribute('style', 'width: 100%');  
			fillSelect(phase, ["none", "A", "B", "C", "AB", "BC", "CA"]);
			 
			var modifier = document.createElement("select");
			modifier.setAttribute("name", "nxa");
			modifier.setAttribute('class', "nxa");
			modifier.setAttribute('style', 'width: 100%');  
			fillSelect(modifier, ["none", "max", "avg", "min"]);

			var disprows = document.createElement("select");
			disprows.setAttribute("name", "row");
			disprows.setAttribute('class', "row");
			disprows.setAttribute('style', 'width: 100%');  
			fillSelect(disprows, ["one", "two"]);

			var deleteRowBox = document.createElement("input");
			deleteRowBox.setAttribute("type", "button");
			deleteRowBox.setAttribute("value", "Delete");
			deleteRowBox.setAttribute("onclick", "SomeDeleteRowFunction(this);");
			deleteRowBox.setAttribute("class", "button");
			deleteRowBox.setAttribute("style", "width: 85px !important;");
			

			currentRow.setAttribute("measurement", true);
			currentRow.measurement = {nm:"", scl:getNamesFromScaling()[0], phs:"none", nxa:"none", row:"one"}
			
			var currentCell = currentRow.insertCell(-1);
			name.onblur = update_measurement_onblur(currentRow);
			currentCell.appendChild(name);

			currentCell = currentRow.insertCell(-1);
			scalingSelect.onblur = update_measurement_onblur(currentRow);
			currentCell.appendChild(scalingSelect);

			currentCell = currentRow.insertCell(-1);
			phase.onblur = update_measurement_onblur(currentRow);
			currentCell.appendChild(phase);
			
			currentCell = currentRow.insertCell(-1);
			modifier.onblur = update_measurement_onblur(currentRow);
			currentCell.appendChild(modifier);

			currentCell = currentRow.insertCell(-1);
			disprows.onblur = update_measurement_onblur(currentRow);
			currentCell.appendChild(disprows);
			
			currentCell = currentRow.insertCell(-1);
			currentCell.appendChild(deleteRowBox);

			name.focus();
		}



function update_scaling_onblur(scl) {
	function inner_handler(evt) {
		scl.flexscaling[evt.target.name] = evt.target.value;
	}
	return inner_handler
}

function update_measurement_onblur(scl) {
	function inner_handler(evt) {
		scl.measurement[evt.target.name] = evt.target.value;
	}
	return inner_handler
}


//select auto-filling
$(document).on('focus','.scl', function(){


  var currentValue = $(this).val();

  $(this).children("option").remove(); // Remove all <option> child tags.
  
  var sclng_tbl = id('scaling_tbl');
	var sclng_lst = scaling_tbl.querySelectorAll("[flexscaling]");
	names = [];
		for (eac of sclng_lst) {
				$(this).append( // Append an object to the inside of the select box
					$("<option></option>") // Yes you can do this.
						.text(eac.flexscaling.nm)
						.val(eac.flexscaling.nm)
				);
		}
	
	$(this).val(currentValue);    
	//console.log(currentValue);
});


//getting the nm values off the scalings table
function getNamesFromScaling(){
		 var sclng_tbl = id('scaling_tbl');
		 var sclng_lst = scaling_tbl.querySelectorAll("[flexscaling]");
			names = [];
			for (eac of sclng_lst) {
				names.push(eac.flexscaling.nm);
			}
			
			return names;
}



function parse_vars(data, source) {
	
	// Create a table row with scaling object attached
	function createScalingRow(pts) {
		
		function inner(scl, item, length, clase, clasi) {
			td = document.createElement('td');
			ti = document.createElement('input');
			ti.setAttribute('name', item);
			ti.setAttribute('maxlength', length);
			ti.value = scl.flexscaling[item];
			ti.onblur = update_scaling_onblur(sr);
			ti.setAttribute('class', clasi);
			td.setAttribute('class', clase);
			td.appendChild(ti);
			return td;
		}
		
		var sr = document.createElement('tr');
		sr.setAttribute('flexscaling', true);   // for queryselect
		sr.flexscaling = pts;
		sr.appendChild(inner(sr, "nm", 31));
		sr.appendChild(inner(sr, "x1", 12, "color-p1", "point-input"));
		sr.appendChild(inner(sr, "y1", 12, "color-p1", "point-input seven-seg"));
		sr.appendChild(inner(sr, "x2", 12, "color-p2", "point-input"));
		sr.appendChild(inner(sr, "y2", 12, "color-p2", "point-input seven-seg"));
		
		
		//Delete button
					
			var deleteButton = document.createElement("input");
			deleteButton.setAttribute("type", "button");
			deleteButton.setAttribute("value", "Delete");
			deleteButton.setAttribute("onclick", "SomeDeleteRowFunction(this);");
			deleteButton.setAttribute("class", "button");
			deleteButton.setAttribute("style", "width: 85px !important; padding.right: 10px;");
			
			var deleteButtonTd = document.createElement('td');
			deleteButtonTd.appendChild(deleteButton);
			
			sr.appendChild(deleteButtonTd);
			
		return sr;
		
	}
	
	
	
	// Create a table row with measurement object attached
	function createMeasurementRow(pts) {
		
		function innerInput(scl, item, length) {
			td = document.createElement('td');
			ti = document.createElement('input');
			ti.setAttribute('name', item);
			ti.setAttribute('maxlength', length);
			ti.value = scl.measurement[item];
			ti.onblur = update_measurement_onblur(sr);
			td.appendChild(ti);
			return td;
		}
		
		
		function innerSelect(scl, item, options) {
			td = document.createElement('td');
			ts = document.createElement('select');
			ts.setAttribute('name', item);
			ts.setAttribute('class', item);
			ts.setAttribute('style', 'width: 100%');            
			ts.onblur = update_measurement_onblur(sr);
			
			for (var each of options) {
			  var option = document.createElement("option");
			  option.setAttribute("value", each);
			  option.text = each;
			  
				  //select the value
				  if(each == scl.measurement[item]){
				  	option.setAttribute("selected", true);	
				  }
			  
			  ts.appendChild(option);
			}
			
			td.appendChild(ts);
			return td;
		}
		
		var sr = document.createElement('tr');
		sr.setAttribute('measurement', true);   // for queryselect
		sr.measurement = pts;
		sr.appendChild(innerInput(sr, "nm", 31));
		sr.appendChild(innerSelect(sr, "scl", getNamesFromScaling())); //***********list of scalings
		sr.appendChild(innerSelect(sr, "phs", ["none", "A", "B", "C", "AB", "BC", "CA"]));
		sr.appendChild(innerSelect(sr, "nxa", ["none", "max", "avg", "min"]));
		sr.appendChild(innerSelect(sr, "row", ["one", "two"]));
		
		
		
		//Delete button
					
			var deleteButton = document.createElement("input");
			deleteButton.setAttribute("type", "button");
			deleteButton.setAttribute("value", "Delete");
			deleteButton.setAttribute("onclick", "SomeDeleteRowFunction(this);");
			deleteButton.setAttribute("class", "button");
			deleteButton.setAttribute("style", "width: 85px !important; padding.right: 10px;");
			
			var deleteButtonTd = document.createElement('td');
			deleteButtonTd.appendChild(deleteButton);
			
			sr.appendChild(deleteButtonTd);
			
		return sr;
		
	}
	
	
	

	// SCALING table fill. Locate the table and append each scaling as a row
	var tb = id('tablebodyScalings');
	while (tb.firstChild) tb.removeChild(tb.firstChild);
	
	var scaling_lst = JSON.parse(data).scalings;	
	
	for (scl of scaling_lst) {
			tb.appendChild(createScalingRow(points_from_slpoff(scl)));	
	}
	
	// MEASUREMENT table fill. Locate the table and append each scaling as a row
	var tb = id('tablebodyMeasurements');
	while (tb.firstChild) tb.removeChild(tb.firstChild);

	var measurement_lst = JSON.parse(data).measurements;	
	
	for (scl of measurement_lst) {
			if (!("row" in scl)) scl["row"] = "one";
			tb.appendChild(createMeasurementRow(scl));	
	}
}

function validate(jsonData, jsonSchema) {
	if (tv4.validate(jsonData, jsonSchema)) {
		return true
	} else {
		throw "Invalid Json file: "+tv4.error.message+" on "+tv4.error.dataPath;
	}
}

function serialize() {
	

		//async json schema fetch
		fetch('FlexScale.schema.json')
		.then(function(resp){
			return resp.json();
		})
		.then(function(data){
			
			jsonSchema = {};
			jsonSchema = data;
			
			obj = specialFormat();
			try {
				var valid = validate(obj, jsonSchema);
				var payload = firmware_json_from(JSON.stringify(obj))
			} catch (error) {
				error += "\nFix entry and press Apply."
				alert(error)
				console.log(error)
				valid = false
			}

			if(valid == true){ // file is valid
				var formdata = new FormData();
				formdata.append("flex", payload);

				var xhr = new XMLHttpRequest();
				xhr.open("POST", "flexscale", true);
				xhr.onreadystatechange = function () {
					if (xhr.readyState === 4 && xhr.status === 200) {
						console.log(xhr.response);
						$(document.body).append(xhr.response);
						pendingCheck();
					}
				};
				xhr.send(formdata);
			}
		})
	}
	

function pendingCheck(){
	
			fetch('pending.cgi')
		.then(function(resp){
			return resp.text();
		})
		.then(function(data){
			
			var parsed = data.split( "\n" );
			var pending_changes = parsed[0];
			check_pending(pending_changes);

		})
}	
	
function stopUpload(success, fname)
{
	if (success == 1)
	{
        id("upbox").style.backgroundColor = "#e8fee4";
		id("msg").text = 'Settings stored successfully!';
	}
	else
	{
		id("upbox").style.backgroundColor = "#fcc";
		id("msg").text = 'Failed to store settings to device.';
	}
	msg_reset_if_pending(1);
}

function load_once() {
	populate("settings.html");
	makeRequest(nc("flexscale"), null);
	pendingCheck();   
	
}

window.onload=load_once;
//-->
</script>
</body></html>
